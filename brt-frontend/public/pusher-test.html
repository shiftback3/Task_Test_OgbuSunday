<!DOCTYPE html>
<html>
<head>
  <title>Pusher Test - BRT Notifications</title>
  <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ğŸ”” Pusher Test - BRT Notifications</h1>
  
  <div>
    <h3>Connection Status:</h3>
    <div id="connection-status" class="log">Connecting...</div>
  </div>

  <div>
    <h3>Actions:</h3>
    <button onclick="testManualNotification()">ğŸ”” Test Manual Browser Notification</button>
    <button onclick="triggerBackendTest()">ğŸš€ Trigger Backend Test Event</button>
  </div>

  <div>
    <h3>Event Log:</h3>
    <div id="event-log"></div>
  </div>

  <script>
    // Enable pusher logging
    Pusher.logToConsole = true;

    // Initialize Pusher with the same config as React app
    var pusher = new Pusher('76a59b72f9aad3c44f86', {
      cluster: 'us3',
      forceTLS: true,
      encrypted: true
    });

    var channel = pusher.subscribe('brt-notifications');
    
    // Connection event handlers
    pusher.connection.bind('connected', function() {
      log('âœ… Pusher connected successfully!', 'success');
      log('Socket ID: ' + pusher.connection.socket_id, 'success');
    });

    pusher.connection.bind('disconnected', function() {
      log('âŒ Pusher disconnected', 'error');
    });

    pusher.connection.bind('error', function(err) {
      log('âŒ Pusher connection error: ' + JSON.stringify(err), 'error');
    });

    pusher.connection.bind('state_change', function(states) {
      log('ğŸ”„ State change: ' + states.previous + ' â†’ ' + states.current);
      document.getElementById('connection-status').textContent = 'State: ' + states.current;
      document.getElementById('connection-status').className = 'log ' + (states.current === 'connected' ? 'success' : '');
    });

    // Channel event handlers
    channel.bind('pusher:subscription_succeeded', function() {
      log('âœ… Successfully subscribed to brt-notifications channel', 'success');
    });

    channel.bind('pusher:subscription_error', function(err) {
      log('âŒ Subscription error: ' + JSON.stringify(err), 'error');
    });

    // Listen for our BRT notification events
    channel.bind('brt.notification', function(data) {
      log('ğŸ”¥ âœ… INCOMING BRT NOTIFICATION!', 'success');
      log('ğŸ“‹ Data: ' + JSON.stringify(data, null, 2));
      
      // Show browser notification
      if (Notification.permission === 'granted') {
        try {
          new Notification(data.title || 'BRT Notification', {
            body: data.message || 'New BRT event received',
            icon: '/favicon.ico',
            tag: data.brt ? data.brt.brt_code : 'brt-notification'
          });
          log('ğŸ”” âœ… Browser notification shown!', 'success');
        } catch (error) {
          log('ğŸ”” âŒ Browser notification failed: ' + error.message, 'error');
        }
      } else {
        log('ğŸ”” âš ï¸ Browser notifications not permitted: ' + Notification.permission);
      }
    });

    // Listen for ALL events on this channel (debugging)
    channel.bind_global(function(event, data) {
      log('ğŸ“¡ ALL EVENTS - ' + event + ': ' + JSON.stringify(data));
    });

    // Helper functions
    function log(message, type = '') {
      const timestamp = new Date().toLocaleTimeString();
      const logDiv = document.createElement('div');
      logDiv.className = 'log ' + type;
      logDiv.textContent = '[' + timestamp + '] ' + message;
      document.getElementById('event-log').appendChild(logDiv);
      
      // Auto-scroll to bottom
      logDiv.scrollIntoView({ behavior: 'smooth' });
      
      console.log(message);
    }

    function testManualNotification() {
      if (Notification.permission === 'granted') {
        try {
          new Notification('ğŸ”” Manual Test', {
            body: 'If this pops up, browser notifications are working!',
            icon: '/favicon.ico'
          });
          log('âœ… Manual notification sent', 'success');
        } catch (error) {
          log('âŒ Manual notification failed: ' + error.message, 'error');
        }
      } else if (Notification.permission === 'default') {
        Notification.requestPermission().then(function(permission) {
          log('Notification permission: ' + permission);
          if (permission === 'granted') {
            testManualNotification();
          }
        });
      } else {
        log('âŒ Notifications are blocked', 'error');
      }
    }

    function triggerBackendTest() {
      // This will call the backend test API
      fetch('http://127.0.0.1:8000/api/v1/test-notification')
        .then(response => response.json())
        .then(data => {
          log('âœ… Backend test triggered: ' + JSON.stringify(data), 'success');
        })
        .catch(error => {
          log('âŒ Backend test failed: ' + error.message, 'error');
        });
    }

    // Request notification permission on load
    if (Notification.permission === 'default') {
      Notification.requestPermission().then(function(permission) {
        log('Initial notification permission: ' + permission);
      });
    } else {
      log('Initial notification permission: ' + Notification.permission);
    }

    log('ğŸš€ Pusher test page loaded');
  </script>
</body>
</html>